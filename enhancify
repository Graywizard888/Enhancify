#!/data/data/com.termux/files/usr/bin/bash

SRC="$HOME/Enhancify"

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
CYAN='\033[0;36m'
WHITE='\033[1;37m'
BOLD='\033[1m'
RESET='\033[0m'

LIGHT_GREEN='\033[1;32m'
LIGHT_CYAN='\033[1;36m'
LIGHT_YELLOW='\033[1;33m'
DIM='\033[2m'

SUCCESS="${GREEN}âœ“${RESET}"
ERROR="${RED}âœ—${RESET}"
WARNING="${YELLOW}âš ${RESET}"
INFO="${CYAN}â„¹${RESET}"
ARROW="${MAGENTA}âžœ${RESET}"

UPDATE_AVAILABLE=false

print_success() {
    echo -e "${SUCCESS} ${GREEN}$1${RESET}"
}

print_error() {
    echo -e "${ERROR} ${RED}$1${RESET}"
}

print_warning() {
    echo -e "${WARNING} ${YELLOW}$1${RESET}"
}

print_info() {
    echo -e "${INFO} ${CYAN}$1${RESET}"
}

print_step() {
    echo -e "${ARROW} ${WHITE}$1${RESET}"
}

print_header() {
    echo -e "\n${BOLD}${MAGENTA}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
    echo -e "${BOLD}${WHITE}  $1${RESET}"
    echo -e "${BOLD}${MAGENTA}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}\n"
}

installJavaWithProgress() {
    local JAVA_PKG="$1"
    local TEMP_LOG=$(mktemp)
    local PID

    tput civis 2>/dev/null

    local SPINNER=('â£¾' 'â£½' 'â£»' 'â¢¿' 'â¡¿' 'â£Ÿ' 'â£¯' 'â£·')
    local SPINNER_IDX=0

    local BAR_WIDTH=30
    local PROGRESS=0
    local STATUS="Initializing..."
    local DOWNLOAD_INFO=""
    local PHASE=0

    local BAR_FILLED="â”"
    local BAR_EMPTY="â”€"
    local BAR_HEAD="â–¶"

    pkg install "$JAVA_PKG" -y > "$TEMP_LOG" 2>&1 &
    PID=$!

    echo ""
    echo ""
    echo ""

    while kill -0 $PID 2>/dev/null; do
        if [ -f "$TEMP_LOG" ]; then
            local LAST_LINES=$(tail -5 "$TEMP_LOG" 2>/dev/null)

            if echo "$LAST_LINES" | grep -qi "reading package"; then
                STATUS="Reading package lists..."
                PROGRESS=5
                PHASE=1
            elif echo "$LAST_LINES" | grep -qi "building dependency"; then
                STATUS="Building dependency tree..."
                PROGRESS=10
                PHASE=2
            elif echo "$LAST_LINES" | grep -qi "the following.*packages will be"; then
                STATUS="Resolving dependencies..."
                PROGRESS=15
                PHASE=3
            elif echo "$LAST_LINES" | grep -qi "need to get\|get:"; then
                local DL_INFO=$(echo "$LAST_LINES" | grep -oi "get:[0-9]*.*" | tail -1)
                if [ -n "$DL_INFO" ]; then
                    DOWNLOAD_INFO="${DL_INFO:0:35}"
                fi
                STATUS="Downloading packages..."
                if [ $PHASE -lt 4 ]; then
                    PROGRESS=20
                    PHASE=4
                elif [ $PROGRESS -lt 55 ]; then
                    PROGRESS=$((PROGRESS + 1))
                fi
            elif echo "$LAST_LINES" | grep -qi "fetched"; then
                STATUS="Download complete..."
                PROGRESS=60
                PHASE=5
                DOWNLOAD_INFO=""
            elif echo "$LAST_LINES" | grep -qi "selecting\|unpacking"; then
                local PKG_NAME=$(echo "$LAST_LINES" | grep -oi "unpacking [^ ]*" | tail -1 | cut -d' ' -f2)
                if [ -n "$PKG_NAME" ]; then
                    STATUS="Unpacking ${PKG_NAME:0:20}..."
                else
                    STATUS="Unpacking packages..."
                fi
                if [ $PHASE -lt 6 ]; then
                    PROGRESS=65
                    PHASE=6
                elif [ $PROGRESS -lt 80 ]; then
                    PROGRESS=$((PROGRESS + 1))
                fi
            elif echo "$LAST_LINES" | grep -qi "setting up"; then
                local PKG_NAME=$(echo "$LAST_LINES" | grep -oi "setting up [^ ]*" | tail -1 | cut -d' ' -f3)
                if [ -n "$PKG_NAME" ]; then
                    STATUS="Setting up ${PKG_NAME:0:20}..."
                else
                    STATUS="Setting up packages..."
                fi
                if [ $PHASE -lt 7 ]; then
                    PROGRESS=85
                    PHASE=7
                elif [ $PROGRESS -lt 95 ]; then
                    PROGRESS=$((PROGRESS + 1))
                fi
            elif echo "$LAST_LINES" | grep -qi "processing triggers"; then
                STATUS="Processing triggers..."
                PROGRESS=95
                PHASE=8
            fi
        fi

        local FILLED=$((PROGRESS * BAR_WIDTH / 100))
        local EMPTY=$((BAR_WIDTH - FILLED))

        local BAR=""
        for ((i=0; i<FILLED; i++)); do
            BAR+="${BAR_FILLED}"
        done
        if [ $FILLED -lt $BAR_WIDTH ]; then
            BAR+="${BAR_HEAD}"
            for ((i=0; i<EMPTY-1; i++)); do
                BAR+="${BAR_EMPTY}"
            done
        fi

        local BAR_COLOR="${CYAN}"
        if [ $PROGRESS -ge 75 ]; then
            BAR_COLOR="${GREEN}"
        elif [ $PROGRESS -ge 50 ]; then
            BAR_COLOR="${LIGHT_CYAN}"
        elif [ $PROGRESS -ge 25 ]; then
            BAR_COLOR="${YELLOW}"
        fi

        printf "\033[3A"
        printf "\033[K  ${MAGENTA}${SPINNER[$SPINNER_IDX]}${RESET} ${WHITE}${BOLD}%s${RESET}\n" "$JAVA_PKG"
        printf "\033[K    ${BAR_COLOR}[%s]${RESET} ${WHITE}%3d%%${RESET}\n" "$BAR" "$PROGRESS"
        printf "\033[K    ${DIM}%s${RESET} ${CYAN}%s${RESET}\n" "$STATUS" "$DOWNLOAD_INFO"

        SPINNER_IDX=$(( (SPINNER_IDX + 1) % ${#SPINNER[@]} ))

        sleep 0.15
    done

    wait $PID
    local EXIT_CODE=$?

    printf "\033[3A"
    printf "\033[K"
    printf "\033[K"
    printf "\033[K"
    printf "\033[3A"

    if [ $EXIT_CODE -eq 0 ] && command -v java &>/dev/null; then
        local FULL_BAR=""
        for ((i=0; i<BAR_WIDTH; i++)); do
            FULL_BAR+="${BAR_FILLED}"
        done

        echo -e "  ${GREEN}âœ“${RESET} ${WHITE}${BOLD}$JAVA_PKG${RESET}"
        echo -e "    ${GREEN}[${FULL_BAR}]${RESET} ${GREEN}${BOLD}100%${RESET}"
        echo -e "    ${GREEN}Installation completed successfully!${RESET}"
        echo ""

        rm -f "$TEMP_LOG"
        return 0
    else
        local EMPTY_BAR=""
        for ((i=0; i<BAR_WIDTH; i++)); do
            EMPTY_BAR+="${BAR_EMPTY}"
        done

        echo -e "  ${RED}âœ—${RESET} ${WHITE}${BOLD}$JAVA_PKG${RESET}"
        echo -e "    ${RED}[${EMPTY_BAR}]${RESET} ${RED}${BOLD}Failed${RESET}"
        echo -e "    ${RED}Installation failed!${RESET}"
        echo ""

        if [ -f "$TEMP_LOG" ]; then
            local ERROR_MSG=$(grep -i "error\|failed\|unable" "$TEMP_LOG" | tail -1)
            if [ -n "$ERROR_MSG" ]; then
                echo -e "    ${DIM}${ERROR_MSG:0:50}${RESET}"
            fi
        fi

        rm -f "$TEMP_LOG"
        return 1
    fi
}

uninstallJavaWithProgress() {
    local JAVA_PKG="$1"
    local TEMP_LOG=$(mktemp)
    local PID

    local SPINNER=('â£¾' 'â£½' 'â£»' 'â¢¿' 'â¡¿' 'â£Ÿ' 'â£¯' 'â£·')
    local SPINNER_IDX=0

    echo ""
    print_step "Uninstalling $JAVA_PKG..."

    pkg uninstall "$JAVA_PKG" -y > "$TEMP_LOG" 2>&1 &
    PID=$!

    while kill -0 $PID 2>/dev/null; do
        printf "\r\033[K  ${YELLOW}${SPINNER[$SPINNER_IDX]}${RESET} ${DIM}Removing packages...${RESET}"
        SPINNER_IDX=$(( (SPINNER_IDX + 1) % ${#SPINNER[@]} ))
        sleep 0.1
    done

    wait $PID
    local EXIT_CODE=$?

    printf "\r\033[K"

    if [ $EXIT_CODE -eq 0 ]; then
        print_success "$JAVA_PKG uninstalled successfully"
    else
        print_warning "Some issues during uninstallation (continuing anyway)"
    fi

    pkg autoremove -y &>/dev/null

    rm -f "$TEMP_LOG"
    return 0
}

checkJavaAvailable() {
    local JAVA_PKG="$1"
    pkg search "$JAVA_PKG" 2>/dev/null | grep -q "^$JAVA_PKG\|/$JAVA_PKG"
    return $?
}

detectJavaVersion() {
    if ! command -v java &>/dev/null; then
        echo "none"
        return
    fi

    local JAVA_VER_OUTPUT=$(java -version 2>&1)

    local VERSION_LINE=$(echo "$JAVA_VER_OUTPUT" | head -1)

    if echo "$VERSION_LINE" | grep -qE "\"25\.|version \"25|openjdk 25| 25\."; then
        echo "25"
    elif echo "$VERSION_LINE" | grep -qE "\"21\.|version \"21|openjdk 21| 21\."; then
        echo "21"
    elif echo "$VERSION_LINE" | grep -qE "\"17\.|version \"17|openjdk 17| 17\."; then
        echo "17"
    else
        local MAJOR_VER=$(echo "$VERSION_LINE" | grep -oE '[0-9]+' | head -1)
        if [ "$MAJOR_VER" == "25" ]; then
            echo "25"
        elif [ "$MAJOR_VER" == "21" ]; then
            echo "21"
        elif [ "$MAJOR_VER" == "17" ]; then
            echo "17"
        else
            echo "other"
        fi
    fi
}

getJavaPackageName() {
    local VERSION="$1"
    case "$VERSION" in
        "25") echo "openjdk-25" ;;
        "21") echo "openjdk-21" ;;
        "17") echo "openjdk-17" ;;
        *) echo "openjdk-17" ;;
    esac
}

promptJavaUpgrade() {
    local CURRENT_VERSION="$1"

    echo ""
    echo -e "${YELLOW}â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®${RESET}"
    echo -e "${YELLOW}â”‚${RESET}                                                  ${YELLOW}â”‚${RESET}"
    echo -e "${YELLOW}â”‚${RESET}  ${WHITE}${BOLD}âš¡ Java Upgrade Recommendation${RESET}                  ${YELLOW}â”‚${RESET}"
    echo -e "${YELLOW}â”‚${RESET}                                                  ${YELLOW}â”‚${RESET}"
    echo -e "${YELLOW}â”‚${RESET}  ${DIM}Current:${RESET} ${RED}openjdk-${CURRENT_VERSION}${RESET}                           ${YELLOW}â”‚${RESET}"
    echo -e "${YELLOW}â”‚${RESET}  ${DIM}Available:${RESET} ${GREEN}openjdk-25${RESET} ${CYAN}(Recommended)${RESET}          ${YELLOW}â”‚${RESET}"
    echo -e "${YELLOW}â”‚${RESET}                                                  ${YELLOW}â”‚${RESET}"
    echo -e "${YELLOW}â”‚${RESET}  ${DIM}Benefits:${RESET}                                      ${YELLOW}â”‚${RESET}"
    echo -e "${YELLOW}â”‚${RESET}   ${GREEN}â€¢${RESET} Better patching performance              ${YELLOW}â”‚${RESET}"
    echo -e "${YELLOW}â”‚${RESET}   ${GREEN}â€¢${RESET} Latest tweaks & improvements              ${YELLOW}â”‚${RESET}"
    echo -e "${YELLOW}â”‚${RESET}                                                  ${YELLOW}â”‚${RESET}"
    echo -e "${YELLOW}â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯${RESET}"
    echo ""
    echo -ne "  ${CYAN}âžœ${RESET} ${WHITE}Upgrade to openjdk-25? [y/N]: ${RESET}"
    read -r UPGRADE_CHOICE

    if [[ "$UPGRADE_CHOICE" =~ ^[Yy]$ ]]; then
        return 0
    else
        return 1
    fi
}

HELP="${BOLD}${CYAN}enhancify${RESET}

${WHITE}Usage:${RESET} ${GREEN}enhancify${RESET} ${YELLOW}[OPTION]${RESET}

${WHITE}Options:${RESET}
  ${YELLOW}-f${RESET}  Force re-install Enhancify
  ${YELLOW}-u${RESET}  Disable Update Check
  ${YELLOW}-r${RESET}  Disable Root access
  ${YELLOW}-R${RESET}  Disable Rish access
  ${YELLOW}-v${RESET}  Print current version
  ${YELLOW}-h${RESET}  Print help statement"

while getopts ":furRvh" OPT 2> /dev/null; do
    case $OPT in
        f)
            rm "$SRC/.info" &> /dev/null
            ;;
        u)
            INTERNET_ACCESS=false
            ;;
        r)
            ROOT_ACCESS=false
            ;;
        R)
            RISH_ACCESS=false
            ;;
        v)
            if [ -e "$SRC" ]; then
                source "$SRC/.info"
                echo -e "${GREEN}Version: ${WHITE}${BOLD}$VERSION${RESET}"
            else
                print_error "Enhancify not installed !!"
            fi
            exit
            ;;
        h)
            echo -e "$HELP"
            exit
            ;;
        ?)
            print_error "Invalid option specified: ${YELLOW}-${OPTARG}${RESET}"
            echo -e "$HELP"
            exit 1
            ;;
    esac
done

terminate() {
    killall -9 curl &> /dev/null
    killall -9 wget &> /dev/null
    clear
    print_error "Script terminated !!"
    exit 1
}

cleanup() {
    tput cnorm 2>/dev/null
}

trap cleanup EXIT
trap terminate SIGTERM SIGINT SIGABRT

fixLibraryIssues() {
    print_info "Checking for library issues..."

    if ! wget --version &> /dev/null; then
        local ERROR_MSG=$(wget --version 2>&1)

        if grep -q "libandroid-posix-semaphore.so" <<< "$ERROR_MSG" || \
           grep -q "library.*not found" <<< "$ERROR_MSG"; then

            print_error "Critical: Detected library issue"
            print_info "Attempting to fix..."

            print_step "Step 1: Updating packages..."
            if pkg update -y 2>&1 | grep -q "libandroid-posix-semaphore.so"; then
                apt update -y &> /dev/null
            fi

            print_step "Step 2: Fixing missing library..."
            pkg install libandroid-support libuuid libandroid-posix-semaphore -y &> /dev/null

            print_step "Step 3: Fixing broken dependencies..."
            apt --fix-broken install -y &> /dev/null

            print_step "Step 4: Reinstalling wget..."
            pkg install wget -y &> /dev/null

            print_step "Step 5: Upgrading packages..."
            pkg upgrade -y &> /dev/null

            if wget --version &> /dev/null; then
                print_success "Library issue fixed successfully!"
                return 0
            else
                print_warning "Unable to fix library issue automatically"
                print_info "Switching to (Curl) download mechanism..."
                return 0
            fi
        fi
    fi

    print_success "No library issues detected"
    return 0
}

downloadFile() {
    local URL="$1"
    local OUTPUT="$2"
    local SIZE="$3"

    if wget --version &> /dev/null; then
        wget -q --show-progress "$URL" -O "$OUTPUT"
        return $?
    fi

    print_warning "Using curl as fallback..."
    pkg install curl -y
    curl -sL --progress-bar "$URL" -o "$OUTPUT"
    return $?
}

installDependencies() {
    local BINS BIN CTR RESPONSE
    local JAVA_VERSION_INSTALLED=""
    local NEED_JAVA_INSTALL=false
    local PKGS=()

    print_header "Installing Dependencies"

    if ! fixLibraryIssues; then
        print_warning "Library issues failed to solve, using \"Curl\" mechanism..."
    fi

    [ -e "$HOME/storage" ] || termux-setup-storage

    BINS=$(ls "$PREFIX/bin")

    local CURRENT_JAVA_VERSION=$(detectJavaVersion)

    if [ "$CURRENT_JAVA_VERSION" != "none" ]; then
        print_info "Detected Java version: ${WHITE}${BOLD}openjdk-${CURRENT_JAVA_VERSION}${RESET}"

        if [ "$UPDATE_AVAILABLE" == true ]; then
            if [ "$CURRENT_JAVA_VERSION" == "17" ] || [ "$CURRENT_JAVA_VERSION" == "21" ]; then
                if checkJavaAvailable "openjdk-25"; then
                    if promptJavaUpgrade "$CURRENT_JAVA_VERSION"; then
                        local CURRENT_PKG=$(getJavaPackageName "$CURRENT_JAVA_VERSION")
                        uninstallJavaWithProgress "$CURRENT_PKG"
                        NEED_JAVA_INSTALL=true
                        JAVA_VERSION_INSTALLED=""
                    else
                        print_info "Keeping current Java version"
                        JAVA_VERSION_INSTALLED="$CURRENT_JAVA_VERSION"
                    fi
                else
                    print_info "openjdk-25 not available in repository, keeping current version"
                    JAVA_VERSION_INSTALLED="$CURRENT_JAVA_VERSION"
                fi
            elif [ "$CURRENT_JAVA_VERSION" == "25" ]; then
                print_success "Already running the latest Java version!"
                JAVA_VERSION_INSTALLED="25"
            else
                JAVA_VERSION_INSTALLED="$CURRENT_JAVA_VERSION"
            fi
        else
            JAVA_VERSION_INSTALLED="$CURRENT_JAVA_VERSION"
        fi
    else
        NEED_JAVA_INSTALL=true
    fi

    if [ "$NEED_JAVA_INSTALL" == true ] || [ -z "$JAVA_VERSION_INSTALLED" ]; then
        print_info "Installing Java..."
        echo ""

        echo -e "${CYAN}â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®${RESET}"
        echo -e "${CYAN}â”‚${RESET}  ${WHITE}${BOLD}â˜• Java Installation${RESET}                  ${CYAN}â”‚${RESET}"
        echo -e "${CYAN}â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯${RESET}"
        echo ""

        print_step "Searching for openjdk-25..."
        if checkJavaAvailable "openjdk-25"; then
            print_success "openjdk-25 support detected in repository!"
            echo ""

            if installJavaWithProgress "openjdk-25"; then
                JAVA_VERSION_INSTALLED="25"
            else
                print_warning "openjdk-25 installation failed"
            fi
        else
            print_warning "openjdk-25 not available in repository"
        fi

        if [ -z "$JAVA_VERSION_INSTALLED" ]; then
            echo ""
            print_step "Trying openjdk-21..."

            if checkJavaAvailable "openjdk-21"; then
                print_success "openjdk-21 detected in repository!"
                echo ""

                if installJavaWithProgress "openjdk-21"; then
                    JAVA_VERSION_INSTALLED="21"
                else
                    print_warning "Checking for library issues..."
                    fixLibraryIssues

                    if installJavaWithProgress "openjdk-21"; then
                        JAVA_VERSION_INSTALLED="21"
                    else
                        print_warning "openjdk-21 installation failed"
                    fi
                fi
            else
                print_warning "openjdk-21 not available in repository"
            fi
        fi

        if [ -z "$JAVA_VERSION_INSTALLED" ]; then
            echo ""
            print_warning "Falling back to openjdk-17..."
            print_step "Trying openjdk-17..."

            if checkJavaAvailable "openjdk-17"; then
                print_success "openjdk-17 detected in repository!"
                echo ""

                if installJavaWithProgress "openjdk-17"; then
                    JAVA_VERSION_INSTALLED="17"
                else
                    print_error "Failed to install openjdk-17!"
                    return 1
                fi
            else
                print_error "No compatible Java version found in repository!"
                return 1
            fi
        fi

        if [ -n "$JAVA_VERSION_INSTALLED" ]; then
            echo -e "${GREEN}â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®${RESET}"
            echo -e "${GREEN}â”‚${RESET}  ${GREEN}âœ“${RESET} ${WHITE}Java ${BOLD}$JAVA_VERSION_INSTALLED${RESET}${WHITE} installed successfully!${RESET}   ${GREEN}â”‚${RESET}"
            echo -e "${GREEN}â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯${RESET}"
            echo ""
        fi
    fi

    BINS=$(ls "$PREFIX/bin")

    grep -q wget <<< "$BINS" || PKGS+=("wget")
    grep -q tput <<< "$BINS" || PKGS+=("ncurses-utils")
    grep -q dialog <<< "$BINS" || PKGS+=("dialog")
    grep -q pup <<< "$BINS" || PKGS+=("pup")
    grep -q jq <<< "$BINS" || PKGS+=("jq")
    grep -q aria2c <<< "$BINS" || PKGS+=("aria2")
    grep -q '^unzip$' <<< "$BINS" || PKGS+=("unzip")
    grep -q '^zip$' <<< "$BINS" || PKGS+=("zip")

    if [ "${#PKGS[@]}" -ne 0 ]; then
        print_info "Installing packages: ${YELLOW}${PKGS[*]}${RESET}"

        if ! pkg update 2>&1; then
            fixLibraryIssues
            pkg update || return 1
        fi

        if ! yes | pkg install "${PKGS[@]}" 2>&1; then
            fixLibraryIssues
            yes | pkg install "${PKGS[@]}" || return 1
        fi
    fi

    sed -i '/allow-external-apps/s/# //' "$HOME/.termux/termux.properties" 2>/dev/null

    [ -e "$SRC/bin" ] || mkdir -p "$SRC/bin"

    AAPT2="$SRC/bin/aapt2"
    APK_EDITOR="$SRC/bin/APKEditor.jar"

    CTR=0 && while [ ! -e "$AAPT2" ]; do
        [ $CTR -gt 2 ] && return 1
        echo ""
        print_info "Downloading aapt2..."
        echo ""
        readarray -t RESPONSE < <(curl -s "https://api.github.com/repos/Graywizard888/Custom-Enhancify-aapt2-binary/releases/latest" | jq -r --arg ARCH "$(getprop ro.product.cpu.abi)" '.assets[] | if (.name | test($ARCH)) then (.browser_download_url, .size) else empty end' 2> /dev/null)
        [ "${#RESPONSE[@]}" -eq 0 ] && return 1

        downloadFile "${RESPONSE[0]}" "$AAPT2"
        chmod +x "$AAPT2"

        if [ "${RESPONSE[1]}" == "$(stat -c %s "$AAPT2" 2> /dev/null)" ]; then
            print_success "aapt2 downloaded successfully"
            break
        else
            rm "$AAPT2"
            print_warning "Download verification failed, retrying..."
        fi
        ((CTR++))
    done

    CTR=0 && while [ ! -e "$APK_EDITOR" ]; do
        [ $CTR -gt 2 ] && return 1
        echo ""
        print_info "Downloading APKEditor..."
        echo ""
        readarray -t RESPONSE < <(curl -s "https://api.github.com/repos/REAndroid/APKEditor/releases/latest" | jq -r '.assets[0] | .browser_download_url, .size' 2> /dev/null)
        [ "${#RESPONSE[@]}" -eq 0 ] && return 1

        downloadFile "${RESPONSE[0]}" "$APK_EDITOR"

        if [ "${RESPONSE[1]}" == "$(stat -c %s "$APK_EDITOR" 2> /dev/null)" ]; then
            print_success "APKEditor downloaded successfully"
            break
        else
            rm "$APK_EDITOR"
            print_warning "Download verification failed, retrying..."
        fi
        ((CTR++))
    done

    print_success "All dependencies installed!"
    return 0
}

fetchSrc() {
    [ -e "$SRC/.info" ] && source "$SRC/.info"

    [ "$INTERNET_ACCESS" == false ] && return

    ping -c 1 github.com &> /dev/null || return

    print_header "Checking for Updates"

    print_info "Checking latest release..."

    TAG=$(curl -s 'https://api.github.com/repos/Graywizard888/Enhancify/releases/latest' 2> /dev/null | jq -r '.tag_name')

    if [ "$TAG" == "$VERSION" ]; then
        print_success "You're running the latest version ${GREEN}($VERSION)${RESET}"
        return
    fi

    UPDATE_AVAILABLE=true

    echo -e "${CYAN}â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®${RESET}"
    echo -e "${CYAN}â”‚${RESET}  ${GREEN}ðŸŽ‰ Enhancify ${BOLD}$TAG${RESET}${GREEN} is available!${RESET}      ${CYAN}â”‚${RESET}"
    echo -e "${CYAN}â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯${RESET}"

    print_info "Installing update..."

    downloadFile "https://github.com/Graywizard888/Enhancify/archive/refs/tags/$TAG.zip" "$TAG.zip"

    if [ -e "$TAG.zip" ]; then
        unzip -qo "$TAG.zip"
        rm -rf "$TAG.zip"
        for CONTENT in Enhancify-*/* Enhancify-*/.*; do
            rm -rf "${SRC:?}/$(basename "$CONTENT")"
            mv "$CONTENT" "$SRC/"
        done
        rm -rf Enhancify-* &> /dev/null
        cp -f "$SRC/enhancify" "$PREFIX/bin/enhancify"
        chmod +x "$PREFIX/bin/enhancify"

        echo ""
        print_success "Enhancify ${BOLD}$TAG${RESET}${GREEN} installed successfully!"
        print_info "Launching in 2 seconds..."
        sleep 2
        enhancify
        exit
    else
        print_error "Unable to install Enhancify $TAG !!"
        print_warning "Please try again with proper Internet"
        exit 1
    fi
}

clear

echo -e "${BOLD}${MAGENTA}âœ¦ ${CYAN}E N H A N C I F Y${RESET} ${BOLD}${MAGENTA}âœ¦${RESET}"
echo ""

[ -e "$SRC/.info" ] && source "$SRC/.info"
if [ "$INTERNET_ACCESS" != false ] && ping -c 1 -W 2 github.com &> /dev/null; then
    TAG=$(curl -s --connect-timeout 5 'https://api.github.com/repos/Graywizard888/Enhancify/releases/latest' 2>/dev/null | jq -r '.tag_name' 2>/dev/null)
    if [ -n "$TAG" ] && [ "$TAG" != "null" ] && [ "$TAG" != "$VERSION" ]; then
        UPDATE_AVAILABLE=true
    fi
fi

if ! installDependencies; then
    print_error "Dependencies not installed !!"
    print_warning "Run again with stable internet connection."
    exit 1
fi

fetchSrc

if [ "$ROOT_ACCESS" != false ] && su -c 'exit' &> /dev/null; then
    ROOT_ACCESS=true
    RISH_ACCESS=false
elif [ "$RISH_ACCESS" != false ] && rish -c 'exit' &> /dev/null; then
    ROOT_ACCESS=false
    RISH_ACCESS=true
else
    ROOT_ACCESS=false
    RISH_ACCESS=false
fi

cd "$SRC" &> /dev/null || terminate

echo ""
print_info "Launching Enhancify..."
echo ""

sleep 1

bash main.sh "$ROOT_ACCESS" "$RISH_ACCESS"
EXIT_CODE=$?

if [ "$EXIT_CODE" -eq 0 ]; then
    print_success "Enhancify exited successfully"
else
    print_error "Enhancify exited with code: $EXIT_CODE"
fi

exit "$EXIT_CODE"
